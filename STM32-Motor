// HAl- mode

#include "stm32f4xx.h"

#define PWM_MAX 999

void GPIO_Init(void);
void PWM_Timer_Init(void);
void Set_Left_Wheel_PWM(uint16_t rpwm, uint16_t lpwm);
void Set_Right_Wheel_PWM(uint16_t rpwm, uint16_t lpwm);
void delay(int ms);

int main(void)
{
    GPIO_Init();
    PWM_Timer_Init();

    while(1)
    {
        for(uint16_t duty=0; duty<=PWM_MAX; duty++)
        {
            // 왼쪽 바퀴 RPWM에 듀티 부여, LPWM은 0 (정방향)
            Set_Left_Wheel_PWM(duty, 0);

            // 오른쪽 바퀴 RPWM에 듀티 부여, LPWM은 0 (정방향)
            Set_Right_Wheel_PWM(duty, 0);

            delay(5);
        }
        delay(1000);

        for(uint16_t duty=PWM_MAX; duty>0; duty--)
        {
            Set_Left_Wheel_PWM(duty, 0);
            Set_Right_Wheel_PWM(duty, 0);

            delay(5);
        }
        delay(1000);
    }
}

void GPIO_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN | RCC_AHB1ENR_GPIOCEN | RCC_AHB1ENR_GPIOAEN;

    // LEFT WHEEL RPWM - PB3 (TIM2_CH2)
    GPIOB->MODER &= ~(3 << (3 * 2));
    GPIOB->MODER |=  (2 << (3 * 2));
    GPIOB->AFR[0] &= ~(0xF << (3 * 4));
    GPIOB->AFR[0] |=  (1 << (3 * 4));  // AF1 = TIM2

    // LEFT WHEEL LPWM - PC7 (TIM3_CH2)
    GPIOC->MODER &= ~(3 << (7 * 2));
    GPIOC->MODER |=  (2 << (7 * 2));
    GPIOC->AFR[0] &= ~(0xF << (7 * 4));
    GPIOC->AFR[0] |=  (2 << (7 * 4));  // AF2 = TIM3

    // RIGHT WHEEL RPWM - PB4 (TIM3_CH1)
    GPIOB->MODER &= ~(3 << (4 * 2));
    GPIOB->MODER |=  (2 << (4 * 2));
    GPIOB->AFR[0] &= ~(0xF << (4 * 4));
    GPIOB->AFR[0] |=  (2 << (4 * 4));  // AF2 = TIM3

    // RIGHT WHEEL LPWM - PA8 (TIM1_CH1)
    GPIOA->MODER &= ~(3 << (8 * 2));
    GPIOA->MODER |=  (2 << (8 * 2));
    GPIOA->AFR[1] &= ~(0xF << ((8 - 8) * 4));
    GPIOA->AFR[1] |=  (1 << ((8 - 8) * 4));  // AF1 = TIM1
}

void PWM_Timer_Init(void)
{
    // Enable Clocks for TIM1, TIM2, TIM3
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN | RCC_APB1ENR_TIM3EN;
    RCC->APB2ENR |= RCC_APB2ENR_TIM1EN;

    // TIM2 - LEFT WHEEL RPWM (CH2)
    TIM2->PSC = 83;
    TIM2->ARR = PWM_MAX;
    TIM2->CNT = 0;
    TIM2->CCMR1 &= ~TIM_CCMR1_OC2M;
    TIM2->CCMR1 |= (TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1);  // PWM mode 1
    TIM2->CCMR1 |= TIM_CCMR1_OC2PE;
    TIM2->CCER |= TIM_CCER_CC2E;
    TIM2->CR1 |= TIM_CR1_ARPE;

    // TIM3 - LEFT WHEEL LPWM (CH2) & RIGHT WHEEL RPWM (CH1)
    TIM3->PSC = 83;
    TIM3->ARR = PWM_MAX;
    TIM3->CNT = 0;
    // CH2 - LEFT LPWM
    TIM3->CCMR1 &= ~TIM_CCMR1_OC2M;
    TIM3->CCMR1 |= (TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1);
    TIM3->CCMR1 |= TIM_CCMR1_OC2PE;
    TIM3->CCER |= TIM_CCER_CC2E;
    // CH1 - RIGHT RPWM
    TIM3->CCMR1 &= ~TIM_CCMR1_OC1M;
    TIM3->CCMR1 |= (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1);
    TIM3->CCMR1 |= TIM_CCMR1_OC1PE;
    TIM3->CCER |= TIM_CCER_CC1E;

    TIM3->CR1 |= TIM_CR1_ARPE;

    // TIM1 - RIGHT WHEEL LPWM (CH1)
    TIM1->PSC = 83;
    TIM1->ARR = PWM_MAX;
    TIM1->CNT = 0;
    TIM1->CCMR1 &= ~TIM_CCMR1_OC1M;
    TIM1->CCMR1 |= (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1);
    TIM1->CCMR1 |= TIM_CCMR1_OC1PE;
    TIM1->CCER |= TIM_CCER_CC1E;
    TIM1->BDTR |= TIM_BDTR_MOE;
    TIM1->CR1 |= TIM_CR1_ARPE | TIM_CR1_CEN;

    // Start timers
    TIM2->CR1 |= TIM_CR1_CEN;
    TIM3->CR1 |= TIM_CR1_CEN;
}

void Set_Left_Wheel_PWM(uint16_t rpwm, uint16_t lpwm)
{
    TIM2->CCR2 = rpwm;
    TIM3->CCR2 = lpwm;
}

void Set_Right_Wheel_PWM(uint16_t rpwm, uint16_t lpwm)
{
    TIM3->CCR1 = rpwm;
    TIM1->CCR1 = lpwm;
}

void delay(int ms)
{
    for(int i=0; i<ms; i++)
        for(volatile int j=0; j<3195; j++);
}
